jobs:
  include:
    - stage: Tests
      name: "Kourou Lint"
      language: node_js
      node_js: 12
      cache:
        directories:
          - ~/.npm
          - ~/.cache
          - node_modules # NPM packages

      install:
        - npm install --silent --unsafe-perm
        - npm install --silent --unsafe-perm --only=dev

      script:
        - npm run test:lint

    - stage: Tests
      name: "Kourou Functional Stdout Tests"
      language: node_js
      node_js: 12
      cache:
        directories:
          - ~/.npm
          - ~/.cache
          - node_modules # NPM packages

      install:
        - npm install --silent --unsafe-perm
        - npm install --silent --unsafe-perm --only=dev

      script:
        - npm run test:functional:stdout

    - stage: Tests
      name: "Kourou Functional Cucumber Tests"
      language: node_js
      node_js: 12
      cache:
        directories:
          - ~/.npm
          - ~/.cache
          - node_modules # NPM packages

      install:
        - npm install --silent --unsafe-perm
        - npm install --silent --unsafe-perm --only=dev

      script:
        - bash features/run-kuzzle-stack.sh
        - npm run test:functional:cucumber

    - stage: Deploy
      name: Deploy Kourou on NPM
      if: type = push AND branch = master
      sudo: false
      language: node_js
      node_js: 12
      install:
        - npm install
      deploy:
        provider: npm
        skip_cleanup: true
        email: support@kuzzle.io
        api_key:
          secure: "SF/UsGFDNM+YO3OaMCan/i1hB1mS5z9uVEiBdGhREG+XCmjjkh8vplqInRASZpVRYcyczuHZIZ1yW1TsK5ZF/wyFu4SKMfw2kyLFtAOCOrBONXQICd0H/B5Aj17fbN8slSJPX6upauBGykWJ89StFbYqrEBUVoDfRUGu3A6gxMbzhGQBCnbTRg73VFTZRZRsR5uiHg6O4nZFfQgbUMuO9NvA3lDO5i6HIgaW5vbEPhMtcN5MYus3078HN71xftLkQUF4B23zO8GuC9ktNCUfF+OIqhm9m77DT61oQQ0vWlRxipwtFTnCHGZxTVnmgXLUv18lprreuY2e6HQTavrbeJbAZTuaQ1Hbgkc8u/gyzZoaTlN498QLEE4w72MXcAIUFVLBsxyXbbuuEwxZ5FhIX6pMyl0uh7Hs3owiRvZ5kJU8R6k62+9d1auobJ0zk46ZUlkMy7jbDjGQCQ9ooqONoaKoLT0rS8khngAgoTmVi07IjVPVhkczTYaS/eH37RlnMwBRdTiwl3KXkDzJCA5zDqaO6F78YH0e89GBKMZ8IqiZmVVwnqMyW5icTNZmiGTUw5T7lNzVhVY64H2TrlFJs8nyMaHKHXtK/G7zk5pI346r70etl66wQWG01Diuci9ima1fensJERIaZbsU0TZ5SCnbLpmb46Qq2ekwlVbyCAQ="
        on:
          repo: kuzzleio/kourou
          all_branches: true

